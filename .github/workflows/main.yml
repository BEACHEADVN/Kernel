name: Build Kernels

permissions:
  contents: write
  actions: write

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: "Release Type"
        type: choice
        options: [ Actions, Pre-Release, Release ]
        default: Actions
      ksu_variant:
        description: "KernelSU Variant"
        type: choice
        options: [ KSU, WKSU, Next, RKSU ]
        default: WKSU
      ksu_commit:
        description: "KSU Commit (optional)"
        type: string
        default: ""
        required: false
      build_bypass:
        description: "Build Bypass"
        type: boolean
        default: false
      build_a13_5_15:
        description: "Android 13 - 5.15"
        type: boolean
        default: true

jobs:
  build-a13-5-15:
    if: inputs.build_a13_5_15
    uses: ./.github/workflows/kernel-a13-5-15.yml
    secrets: inherit
    with:
      ksu_variant: ${{ inputs.ksu_variant }}
      ksu_commit: ${{ inputs.ksu_commit }}
      build_bypass: ${{ inputs.build_bypass }}

  rej:
    if: always()
    runs-on: ubuntu-latest
    needs:
      - build-a13-5-15
    steps:
      - name: Download Misc Artifacts
        uses: actions/download-artifact@v5
        with:
          path: ./downloaded-artifacts
          pattern: '*-Rejects'

      - name: Process Reject Artifacts
        run: |
          mkdir -p aio-rejects
          for dir in ./downloaded-artifacts/*-Rejects; do
            [ -d "$dir" ] || continue
            dirname=$(basename "$dir")
            original_name=${dirname%-Rejects}
            mkdir -p "aio-rejects/$original_name"

            if [ -d "$dir/patch-rejects" ]; then
              cp -r "$dir/patch-rejects/." "aio-rejects/$original_name/"
            else
              cp -r "$dir/." "aio-rejects/$original_name/"
            fi
          done

          if [ "$(ls -A aio-rejects)" ]; then
            cd aio-rejects
            zip -r -9 ../AIO-REJ.zip .
            cd ..
          fi

      - name: Upload AIO-REJ Artifact
        uses: actions/upload-artifact@v4
        with:
          name: AIO-REJ
          path: AIO-REJ.zip
          if-no-files-found: ignore

  release:
    runs-on: ubuntu-latest
    if: ${{ inputs.release_type != 'Actions' }}
    needs:
      - build-a13-5-15

    permissions:
      contents: write

    env:
      GH_TOKEN: ${{ github.token }}
      RELEASE_NAME: "!!TESTING!! GKI Kernels With KernelSU & SUSFS v2.0.0 !!TESTING!!"

    outputs:
      new_tag: ${{ steps.tag.outputs.new_tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate New Tag
        id: tag
        run: |
          set -e
          SUSFS_VERSION="2.0.0"
          KSU_VARIANT="${{ inputs.ksu_variant }}"
          PREFIX="${KSU_VARIANT}-susfs${SUSFS_VERSION}"

          LATEST_TAG=$(gh release list --limit 50 --json tagName -q \
            "[.[] | select(.tagName | startswith(\"${PREFIX}-r\"))][0].tagName" || echo "")

          if [[ "$LATEST_TAG" =~ ^${PREFIX}-r([0-9]+)$ ]]; then
            REV="${BASH_REMATCH[1]}"
            NEW_REV=$((REV + 1))
          else
            NEW_REV=1
          fi

          NEW_TAG="${PREFIX}-r${NEW_REV}"
          echo "NEW_TAG=$NEW_TAG" >> $GITHUB_ENV
          echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT

      - name: Set release body
        run: |
          cat << 'EOF' > release_body.md
          !!THIS RELEASE IS A TESTING RELEASE!!

          KernelSU Variant: ${{ inputs.ksu_variant }}
          SUSFS: v2.0.0

          Use at your own risk.
          EOF

      # ðŸ”§ STEP Báº®T BUá»˜C â€“ Táº O RELEASE TRÆ¯á»šC KHI UPLOAD
      - name: Create GitHub Release
        run: |
          PRERELEASE_FLAG=""
          if [ "${{ inputs.release_type }}" = "Pre-Release" ]; then
            PRERELEASE_FLAG="--prerelease"
          fi

          gh release create "$NEW_TAG" \
            --title "$RELEASE_NAME" \
            --notes-file release_body.md \
            --target "${{ github.sha }}" \
            $PRERELEASE_FLAG

      - name: Debug artifacts
        run: |
          ls -R downloaded-artifacts || true

      - name: Download AnyKernel3 Artifacts
        uses: actions/download-artifact@v5
        with:
          path: ./downloaded-artifacts
          pattern: '*-AnyKernel3'

      - name: Upload Release Assets
        run: |
          set -e
          shopt -s nullglob

          mapfile -t anykernel_dirs < <(find ./downloaded-artifacts -type d -name '*-AnyKernel3')

          if [ ${#anykernel_dirs[@]} -eq 0 ]; then
            echo "âŒ No AnyKernel3 artifacts found"
            exit 1
          fi

          for dir in "${anykernel_dirs[@]}"; do
            name=$(basename "$dir")
            zip_path="$GITHUB_WORKSPACE/${name}.zip"

            (cd "$dir" && zip -r -9 "$zip_path" .)
            gh release upload "$NEW_TAG" "$zip_path" --clobber
          done
